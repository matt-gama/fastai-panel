{% extends "base.html" %}
{% block content %}
<div class="leads-container">
    <!-- Sidebar de Leads -->
    <div class="leads-sidebar">
        <div class="leads-header">
            <h2>Leads ({{ leads|length }})</h2>
        </div>
        <div class="leads-list">
            {% for lead in leads %}
            <a href="{{ url_for('get_leads_ia', ia_id=lead.ia_id, lead_id=lead.id) }}" class="lead-item {% if selected_lead and selected_lead.id == lead.id %}active{% endif %}">
                <div class="lead-info">
                    <div class="lead-name">
                        {% if not lead.bloqueado %}
                        <svg class="icon icon-lock" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
                        </svg>
                        {% endif %}
                        <span>{{ lead.name }}</span>
                    </div>
                    <div class="lead-phone">{{ lead.phone }}</div>
                    <div class="lead-date">Última interação: {{ lead.updated_at }}</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Área de Chat -->
    <div class="chat-area">
        {% if selected_lead %}
        <div class="chat-header">
            <div class="chat-title">
                <h2>{{ selected_lead.name }}</h2>
                <div class="chat-subtitle">
                    <div class="chat-info"><span>IA:</span> {{ selected_lead.ia_name }}</div>
                    <div class="chat-info"><span>Unique Token:</span> {{ selected_lead.unique_token }}</div>
                </div>
            </div>
            <div class="chat-actions">
                {% if selected_lead.bloqueado %}
                <button class="btn-action btn-block" data-toggle="modal" data-target="#acaoPromptModal{{ selected_lead.id }}" title="Bloquear lead">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
                    </svg>
                    <span>Bloquear</span>
                </button>
                {% else %}
                <button class="btn-action btn-block" data-toggle="modal" data-target="#acaoPromptModal{{ selected_lead.id }}" title="Desbloquear lead">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V10A2,2 0 0,1 6,8H15V6A3,3 0 0,0 12,3A3,3 0 0,0 9,6H7A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,17A2,2 0 0,0 14,15A2,2 0 0,0 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17Z" />
                    </svg>
                    <span>Desbloquear</span>
                </button>
                {% endif %}
                <button class="btn-action btn-delete" data-toggle="modal" data-target="#deletePromptModal{{ selected_lead.id }}" title="Deletar lead">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                    </svg>
                    <span>Excluir</span>
                </button>
            </div>
        </div>

        <!-- Resumo da Conversa -->
        {% if selected_lead.resume %}
        <div class="resume-section">
            <h3>Resumo</h3>
            <div class="resume-container">
                <textarea class="resume-textarea" rows="5" readonly>{{ selected_lead.resume }}</textarea>
            </div>
        </div>
        {% endif %}

        <div class="chat-divider">
            <span>Chat</span>
        </div>

        <!-- Mensagens do Chat -->
        <div class="chat-messages">
            {% for msg in selected_lead.message %}
            {% if msg.role == 'user' %}
            <!-- Mensagem do Usuário -->
            <div class="message-container user-message">
                <div class="message-bubble">
                    <div class="message-content">{{ msg.content }}</div>
                    {% if msg.name %}
                    <div class="message-meta">{{ msg.name }}</div>
                    {% endif %}
                </div>
            </div>
            {% elif msg.role == 'assistant' %}
            <!-- Mensagem do Assistente -->
            <div class="message-container assistant-message">
                <div class="message-bubble">
                    <div class="message-content">{{ msg.content }}</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Modal para Bloquear/Desbloquear Lead -->
        <div class="modal-overlay" id="acaoPromptModal{{ selected_lead.id }}" tabindex="-1" aria-labelledby="acaoPromptModalLabel{{ selected_lead.id }}" aria-hidden="true">
            <div class="modal-container">
                <div class="modal-content">
                    <form action="/update-lead/{{ selected_lead.id }}" method="POST">
                        <div class="modal-header">
                            <h3 class="modal-title" id="acaoPromptModalLabel{{ selected_lead.id }}">Confirmar Ação</h3>
                            <button type="button" class="modal-close" data-dismiss="modal" aria-label="Fechar">
                                <svg viewBox="0 0 24 24" class="icon">
                                    <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <p>Tem certeza que deseja <strong>{% if selected_lead.bloqueado %}bloquear{% else %}desbloquear{% endif %}</strong> este lead?</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn-primary">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para Deletar Lead -->
        <div class="modal-overlay" id="deletePromptModal{{ selected_lead.id }}" tabindex="-1" aria-labelledby="deletePromptModalLabel{{ selected_lead.id }}" aria-hidden="true">
            <div class="modal-container">
                <div class="modal-content">
                    <form action="/delete-lead/{{ selected_lead.id }}" method="POST">
                        <div class="modal-header">
                            <h3 class="modal-title" id="deletePromptModalLabel{{ selected_lead.id }}">Confirmar Exclusão</h3>
                            <button type="button" class="modal-close" data-dismiss="modal" aria-label="Fechar">
                                <svg viewBox="0 0 24 24" class="icon">
                                    <path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" />
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-danger">
                                <p>Tem certeza que deseja excluir o Lead <strong>{{ selected_lead.name }}</strong>?</p>
                                <p class="alert-small">Esta ação não pode ser desfeita.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn-danger">Excluir</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" width="64" height="64">
                    <path fill="currentColor" d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M6,9H18V11H6M14,14H6V12H14M18,8H6V6H18" />
                </svg>
            </div>
            <h2>Selecione um lead para visualizar o chat</h2>
            <p>Escolha um lead na lista à esquerda para ver as conversas</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    :root {
        --primary: #255267;
        --primary-dark: #1e4252;
        --primary-light: #3a6a80;
        --success: #28a745;
        --success-dark: #218838;
        --danger: #dc3545;
        --danger-dark: #c82333;
        --warning: #ffc107;
        --warning-dark: #e0a800;
        --secondary: #6c757d;
        --secondary-dark: #5a6268;
        --background: #ffffff;
        --background-light: #f8f9fa;
        --text: #333333;
        --text-light: #6c757d;
        --border: #e1e4e8;
        --border-light: #f1f3f5;
        --shadow: rgba(0, 0, 0, 0.1);
    }

    /* Layout Principal */
    .leads-container {
        display: flex;
        height: calc(100vh - 60px); /* Ajuste conforme necessário para seu layout */
        overflow: hidden;
    }

    /* Sidebar de Leads */
    .leads-sidebar {
        width: 320px;
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        background-color: var(--background-light);
    }

    .leads-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .leads-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0;
    }

    .leads-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }

    .lead-item {
        display: block;
        padding: 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
        color: var(--text);
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .lead-item:hover {
        background-color: rgba(37, 82, 103, 0.05);
    }

    .lead-item.active {
        background-color: rgba(37, 82, 103, 0.1);
        border-color: var(--primary-light);
    }

    .lead-info {
        display: flex;
        flex-direction: column;
    }

    .lead-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .lead-phone {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 0.25rem;
    }

    .lead-date {
        font-size: 0.75rem;
        color: var(--text-light);
    }

    /* Área de Chat */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background-color: var(--background);
    }

    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .chat-title h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
    }

    .chat-subtitle {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .chat-info {
        font-size: 0.875rem;
        color: var(--text-light);
    }

    .chat-info span {
        font-weight: 600;
        color: var(--text);
    }

    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Resumo da Conversa */
    .resume-section {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .resume-section h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
    }

    .resume-container {
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .resume-textarea {
        width: 100%;
        padding: 0.75rem;
        border: none;
        font-size: 0.875rem;
        resize: none;
        background-color: var(--background-light);
        color: var(--text);
    }

    /* Divisor de Chat */
    .chat-divider {
        display: flex;
        align-items: center;
        padding: 1rem;
        color: var(--text-light);
        font-size: 0.875rem;
    }

    .chat-divider::before,
    .chat-divider::after {
        content: "";
        flex: 1;
        border-top: 1px solid var(--border);
    }

    .chat-divider span {
        padding: 0 0.75rem;
    }

    /* Mensagens do Chat */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message-container {
        display: flex;
        max-width: 80%;
    }

    .user-message {
        align-self: flex-start;
    }

    .assistant-message {
        align-self: flex-end;
    }

    .message-bubble {
        padding: 0.75rem;
        border-radius: 1rem;
        position: relative;
    }

    .user-message .message-bubble {
        background-color: var(--background-light);
        border-bottom-left-radius: 0.25rem;
    }

    .assistant-message .message-bubble {
        background-color: var(--primary);
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message-content {
        font-size: 0.9375rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .message-meta {
        font-size: 0.75rem;
        color: var(--text-light);
        margin-top: 0.25rem;
    }

    .assistant-message .message-meta {
        color: rgba(255, 255, 255, 0.7);
    }

    /* Estado Vazio */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: var(--text-light);
        text-align: center;
    }

    .empty-icon {
        margin-bottom: 1.5rem;
        color: var(--primary-light);
        opacity: 0.7;
    }

    .empty-state h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 0.9375rem;
        max-width: 400px;
    }

    /* Botões */
    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        outline: none;
        background-color: var(--secondary);
        color: white;
    }

    .btn-action:hover {
        background-color: var(--secondary-dark);
    }

    .btn-block {
        background-color: var(--primary);
    }

    .btn-block:hover {
        background-color: var(--primary-dark);
    }

    .btn-delete {
        background-color: var(--danger);
    }

    .btn-delete:hover {
        background-color: var(--danger-dark);
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-secondary {
        background-color: var(--secondary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-secondary:hover {
        background-color: var(--secondary-dark);
    }

    .btn-danger {
        background-color: var(--danger);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-danger:hover {
        background-color: var(--danger-dark);
    }

    /* Ícones */
    .icon {
        width: 1.25rem;
        height: 1.25rem;
        flex-shrink: 0;
    }

    .icon-lock {
        color: var(--primary);
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
        padding: 2rem 1rem;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
        display: flex;
    }

    .modal-container {
        width: 100%;
        max-width: 500px;
        margin: auto;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-container {
        transform: translateY(0);
    }

    .modal-content {
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
        margin: 0;
    }

    .modal-close {
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-light);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .modal-close:hover {
        background-color: var(--border-light);
        color: var(--text);
    }

    .modal-body {
        padding: 1rem;
        overflow-y: auto;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem;
        border-top: 1px solid var(--border);
    }

    /* Alert Styles */
    .alert {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }

    .alert-warning {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid var(--warning);
    }

    .alert-danger {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid var(--danger);
    }

    .alert-small {
        font-size: 0.875rem;
        margin-top: 0.5rem;
        color: var(--text-light);
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .leads-container {
            flex-direction: column;
            height: auto;
        }

        .leads-sidebar {
            width: 100%;
            height: 300px;
            border-right: none;
            border-bottom: 1px solid var(--border);
        }

        .chat-area {
            height: calc(100vh - 360px);
        }

        .chat-header {
            flex-direction: column;
            gap: 1rem;
        }

        .chat-actions {
            width: 100%;
        }

        .btn-action {
            flex: 1;
        }
    }
</style>

<script>
    // Sistema de Modal Personalizado
    document.addEventListener('DOMContentLoaded', function() {
        // Função para abrir modal
        window.openModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Previne rolagem do body
            
            // Adiciona classe para animação
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Foca no primeiro elemento focável dentro do modal
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusableElements.length) {
                focusableElements[0].focus();
            }
        };
        
        // Função para fechar modal
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.remove('show');
            
            // Espera a animação terminar antes de esconder
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = ''; // Restaura rolagem do body
            }, 300);
        };
        
        // Fecha modal ao clicar no backdrop
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });
        
        // Fecha modal ao pressionar ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal-overlay.show');
                if (openModal) {
                    closeModal(openModal.id);
                }
            }
        });
        
        // Adiciona event listeners para todos os botões que abrem modais
        document.querySelectorAll('[data-toggle="modal"]').forEach(button => {
            const targetId = button.getAttribute('data-target').substring(1); // Remove o # do início
            button.addEventListener('click', function(event) {
                event.preventDefault();
                openModal(targetId);
            });
        });
        
        // Adiciona event listeners para todos os botões que fecham modais
        document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    closeModal(modal.id);
                }
            });
        });
        
        // Rola para o final do chat quando a página carrega
        const chatMessages = document.querySelector('.chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}